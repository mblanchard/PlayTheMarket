<html>
	<head>
		<script src="js/vendor/papaparse.min.js"></script>
		<script src="js/vendor/qwerty-handcock.js"></script>	
	</head>
	<body>
		<div id="keyboard"></div>
		
		

		<script src="js/shims.js"></script>
		<script src="js/parsing.js"></script>
		<script src="js/audioWrapping.js"></script>
		<script src="js/waveShaping.js"></script>		
		<script type="text/javascript">
			window.debug_flag = true,
			 settings = {
                    id: 'keyboard',
                    width: 600,
                    height: 150,
                    startNote: 'A2',
                    whiteNotesColour: '#fff',
                    blackNotesColour: '#000',
                    borderColour: '#000',
                    activeColour: 'yellow',
                    octaves: 2
                },
                keyboard = new QwertyHancock(settings);
			
			var context = audioWrapping.initContext();
			var oscillator = audioWrapping.createOscillator(context,'sine',200);
			var compressor = audioWrapping.createCompressor(context);
			var distortion = null;
			masterGain = context.createGain();
            masterGain.gain.value = 0.3;
             
            masterGain.connect(compressor); 
            compressor.connect(context.destination)
            nodes = [];
			
			parsing.parseStockData("GOOG","2012-03-30","2015-07-30", 
				function(results) {
					results.data.shift();
					results.data.pop();
					var closeValues = results.data.map(function(d){return parseFloat(d[4]);});
					var leveledArray = levelArray(closeValues);
					distortion = waveShaping.createWaveShaperFromArray(leveledArray,1,context,oscillator,compressor);
					distortion.connect(masterGain);
				}
			);	




            keyboard.keyDown = function (note, frequency) {
                var oscillator = context.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                oscillator.connect(distortion);
                oscillator.start(0);

                nodes.push(oscillator);
            };

            keyboard.keyUp = function (note, frequency) {
                var new_nodes = [];

                for (var i = 0; i < nodes.length; i++) {
                    if (Math.round(nodes[i].frequency.value) === Math.round(frequency)) {
                        nodes[i].stop(0);
                        nodes[i].disconnect();
                    } else {
                        new_nodes.push(nodes[i]);
                    }
                }

                nodes = new_nodes;
            };

		</script>
		
	</body>
</html>
	